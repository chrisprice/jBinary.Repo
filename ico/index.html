<!DOCTYPE html>
<html>
<head>
	<script src="https://rawgithub.com/jDataView/jDataView/master/src/jDataView.js"></script>
	<script src="https://rawgithub.com/jDataView/jBinary/master/src/jBinary.js"></script>
	<script src="ico.js"></script>
	<script src="https://rawgithub.com/jonathantneal/2869388/raw/989d46f574934be64348b7caf4cc149b007bf76f/eventListener.js"></script>
	<script>
		addEventListener('load', function () {
			var container = document.getElementById('container');
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');

			function drawToCanvas(bmp, header) {
				var size = header.size,
					imgData = context.createImageData(size.horz, size.vert);

				canvas.width = size.horz;
				canvas.height = size.vert;

				// iterating over resulting bitmap bottom-to-top, left-to-right
				for (var y = size.vert - 1; y > 0; y--) {
					// calculating image data offset for row [y]
					var dataPos = 4 * y * size.horz;

					// iterating over row pixels
					for (var x = 0; x < size.horz; x++) {
						var color;

						switch (header.bpp) {
							case 1:
							case 2:
							case 4:
								color = header.palette[bmp.read(header.bpp)];
								break;

							case 8:
								color = header.palette[bmp.read('uint8')];
								break;

							case 16:
								// extracting RGB values using 5-6-5 encoding scheme and given masks
								colorIndex = bmp.read('uint16');
								color = {
									b: (colorIndex & header.mask.b) << 3,
									g: (colorIndex & header.mask.g) >> 3,
									r: (colorIndex & header.mask.r) >> 8
								};
								break;

							case 24:
								// reading RGB color
								color = bmp.read('RGBTriple');
								break;

							case 32:
								// reading RGBA color
								color = bmp.read('RGBQuad');
								break;

							default:
								throw new TypeError('Sorry, but ' + header.bpp + 'bpp images are not supported.');
						}

						// putting resulting RGBA values to image data
						imgData.data[dataPos++] = color.r;
						imgData.data[dataPos++] = color.g;
						imgData.data[dataPos++] = color.b;
						imgData.data[dataPos++] = color.a !== undefined ? color.a : 255;
					}

					// padding new row's alignment to 4 bytes
					var offsetOverhead = (bmp.tell() - header.dataOffset) % 4;
					if (offsetOverhead) {
						bmp.skip(4 - offsetOverhead);
						bmp._bitShift = 0;
					}
				}

				// putting image data to given canvas context
				context.putImageData(imgData, 0, 0);
			}

			function handleData(err, data) {
				if (err) {
					return alert(err);
				}

				var ico = new jBinary(new jDataView(data, undefined, undefined, true), jBinary.Repo.ICO);
				var iconDir = ico.read('IconDir');
				container.innerHTML = '';
				canvas.width = canvas.height = 0;

				function iterate(info, obj, prefix) {
					for (var key in obj) {
						if (key.charAt(0) === '_') {
							continue;
						}

						var value = obj[key];

						// only simple objects; show array as string to reduce size on screen
						if (value.constructor === Object) {
							iterate(info, value, prefix + key + '.');
						} else {
							if (value.constructor === Array) {
								value = '[...]';
							}

							var row = info.insertRow(-1);

							var head = document.createElement('th');
							head.innerHTML = prefix + key;
							row.appendChild(head);

							var cell = document.createElement('td');
							cell.innerHTML = value;
							row.appendChild(cell);
						}
					}
				}

				for (var i = 0, length = iconDir.length; i < length; i++) {
					var info = document.createElement('table');
					iterate(info, iconDir[i], '');

					var renderLink = document.createElement('a');
					renderLink.href = '#';
					renderLink.innerHTML = 'Render';
					renderLink.addEventListener('click', function (event) {
						var imgIndex = Number(this.getAttribute('data-index'));
						var image = iconDir[imgIndex];
						ico.seek(image.dataOffset);
						var header = ico.read('ImageHeader');
						header.size.vert /= 2;
						drawToCanvas(ico, header);
						event.preventDefault();
					});

					var row = info.insertRow(-1);

					var head = document.createElement('th');
					head.innerHTML = 'Actions';
					row.appendChild(head);

					var cell = document.createElement('td');
					cell.appendChild(renderLink);
					row.appendChild(cell);

					container.appendChild(info);
				}
			}

			document.getElementById('url').addEventListener('click', function (event) {
				var oldTitle = document.title;
				document.title = '...loading, please wait...';
				jBinary.loadData(this.href, function (err, data) {
					document.title = oldTitle;
					handleData.apply(this, arguments);
				});
				event.preventDefault();
			});

			if ('File' in this) {
				document.getElementById('fileApi').style.display = 'block';

				document.getElementById('file').addEventListener('change', function () {
					jBinary.loadData(this.files[0], handleData);
				});
			}
		});
	</script>
	<style type="text/css">
		#fileApi {
			display: none;
		}

		table {
			border-collapse: collapse;
		}

		#container {
			float: left;
		}

		canvas {
			float: left;
			margin-left: 1em;
		}

		th, td {
			border: 1px solid #777;
			padding: 3pt;
		}
	</style>
</head>
<body>
	Load ICO sample: <a id="url" href="sample.ico">Load</a>
	<div id="fileApi">
		<small>or</small><br />
		<label for="file">Choose ICO file:</label><input type="file" id="file" />
	</div>
	<hr />
	<div id="container"></div>
	<canvas id="canvas"></canvas>
</body>
</html>