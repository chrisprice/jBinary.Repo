<!DOCTYPE html>
<html>
<head>
	<script src="https://rawgithub.com/jDataView/jDataView/master/src/jDataView.js"></script>
	<script src="https://rawgithub.com/jDataView/jBinary/master/src/jBinary.js"></script>
	<script src="ico.js"></script>
	<script src="https://rawgithub.com/jonathantneal/2869388/raw/989d46f574934be64348b7caf4cc149b007bf76f/eventListener.js"></script>
	<script>
		addEventListener('load', function () {
			var container = document.getElementById('container');
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');

			function longOperation(name, async) {
				var oldTitle = document.title;
				document.title = 'Please wait, ' + name + '...';
				async(function () {
					document.title = oldTitle;
				});
			}

			function drawToCanvas(ico, image) {
				var imgData = context.createImageData(image.width, image.height);
				var iconImage = ico.read('IconImage', image.dataOffset);

				if ('set' in imgData.data) {
					imgData.data.set(iconImage.pixelData);
				} else {
					for (var i = 0, length = iconImage.pixelData.length; i < length; i++) {
						imgData.data[i] = iconImage.pixelData[i];
					}
				}

				canvas.width = imgData.width;
				canvas.height = imgData.height;

				// putting image data to given canvas context
				context.putImageData(imgData, 0, 0);
			}

			function handleData(err, data) {
				if (err) {
					return alert(err);
				}

				var ico = new jBinary(new jDataView(data, undefined, undefined, true), jBinary.Repo.ICO), iconDir;

				longOperation('parsing', function (done) {
					iconDir = ico.read('IconDir');
					done();
				});

				container.innerHTML = '';
				canvas.width = canvas.height = 0;

				function iterate(info, obj, prefix) {
					for (var key in obj) {
						if (key.charAt(0) === '_') {
							continue;
						}

						var value = obj[key];

						// only simple objects; show array as string to reduce size on screen
						if (value.constructor === Object) {
							iterate(info, value, prefix + key + '.');
						} else {
							if (value.constructor === Array) {
								value = '[...]';
							}

							var row = info.insertRow(-1);

							var head = document.createElement('th');
							head.innerHTML = prefix + key;
							row.appendChild(head);

							var cell = document.createElement('td');
							cell.innerHTML = value;
							row.appendChild(cell);
						}
					}
				}

				for (var i = 0, length = iconDir.length; i < length; i++) {
					var info = document.createElement('table');
					iterate(info, iconDir[i], '');

					var renderLink = document.createElement('a');
					renderLink.href = '#' + i;
					renderLink.innerHTML = 'Render';
					renderLink.addEventListener('click', function (event) {
						var imgIndex = this.href.match(/#(\d+)$/)[1];
						longOperation('rendering', function (done) {
							drawToCanvas(ico, iconDir[imgIndex]);
							done();
						});
						event.preventDefault();
					});

					var row = info.insertRow(-1);

					var head = document.createElement('th');
					head.innerHTML = 'Actions';
					row.appendChild(head);

					var cell = document.createElement('td');
					cell.appendChild(renderLink);
					row.appendChild(cell);

					container.appendChild(info);
				}
			}

			document.getElementById('url').addEventListener('click', function (event) {
				longOperation('loading', function (done) {
					jBinary.loadData(event.target.href, function (err, data) {
						handleData.apply(this, arguments);
						done();
					});
				});
				event.preventDefault();
			});

			if ('File' in this) {
				document.getElementById('fileApi').style.display = 'block';

				document.getElementById('file').addEventListener('change', function () {
					jBinary.loadData(this.files[0], handleData);
				});
			}
		});
	</script>
	<style type="text/css">
		#fileApi {
			display: none;
		}

		table {
			border-collapse: collapse;
		}

		#container {
			float: left;
		}

		canvas {
			float: left;
			margin-left: 1em;
		}

		th, td {
			border: 1px solid #777;
			padding: 3pt;
		}
	</style>
</head>
<body>
	Load ICO sample: <a id="url" href="sample.ico">Load</a>
	<div id="fileApi">
		<small>or</small><br />
		<label for="file">Choose ICO file:</label><input type="file" id="file" />
	</div>
	<hr />
	<div id="container"></div>
	<canvas id="canvas"></canvas>
</body>
</html>