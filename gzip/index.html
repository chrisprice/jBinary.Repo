<!DOCTYPE html>
<html>
<head>
	<script src="https://rawgithub.com/jDataView/jDataView/master/src/jDataView.js"></script>
	<script src="https://rawgithub.com/jDataView/jBinary/master/src/jBinary.js"></script>
	<script src="gzip.js"></script>
	<script src="https://rawgithub.com/dankogai/js-deflate/master/rawinflate.js"></script>
	<script src="https://rawgithub.com/jonathantneal/2869388/raw/989d46f574934be64348b7caf4cc149b007bf76f/eventListener.js"></script>
	<script>
		addEventListener('load', function () {
			var info = document.getElementById('info');

			function longOperation(name, async) {
				var oldTitle = document.title;
				document.title = 'Please wait, ' + name + '...';
				async(function () {
					document.title = oldTitle;
				});
			}

			function handleData(err, data) {
				if (err) {
					return alert(err);
				}

				var gzip = new jBinary(new jDataView(data, undefined, undefined, true), jBinary.Repo.GZIP), file;

				longOperation('parsing', function (done) {
					file = gzip.read('File');
					done();
				}); 

				while (info.firstChild) {
					info.removeChild(info.firstChild);
				}

				function iterate(obj, prefix) {
					for (var key in obj) {
						if (key.charAt(0) === '_') {
							continue;
						}

						var value = obj[key];

						// only simple objects; show array as string to reduce size on screen
						if (value.constructor === Object) {
							iterate(value, prefix + key + '.');
						} else {
							if (value.constructor === Array) {
								value = '[...]';
							}

							var row = info.insertRow(-1);

							var head = document.createElement('th');
							head.innerHTML = prefix + key;
							row.appendChild(head);

							var cell = document.createElement('td');
							cell.innerHTML = value;
							row.appendChild(cell);
						}
					}
				}

				iterate(file, '');

				if (file.compression !== 'Deflate') {
					return;
				}

				var decompressLink = document.createElement('a');
				decompressLink.innerHTML = 'Decompress';
				decompressLink.href = '#';
				decompressLink.download = file.name;
				decompressLink.target = '_blank';
				decompressLink.onclick = function (event) {
					var compressed = file.compressed_binary.read('string', 0);
					var uncompressed = RawDeflate.inflate(compressed);

					// handy method, but only in IE10 as for now :(
					if ('msSaveOrOpenBlob' in navigator) {
						navigator.msSaveBlob(new Blob([uncompressed]), this.download);
						event.preventDefault();
					} else {
						this.href = new jBinary(uncompressed).toURI();
						this.onclick = null;
					}
				};

				var row = info.insertRow(-1);

				var head = document.createElement('th');
				head.innerHTML = 'Actions';
				row.appendChild(head);

				var cell = document.createElement('td');
				cell.appendChild(decompressLink);
				row.appendChild(cell);
			}

			document.getElementById('url').addEventListener('click', function (event) {
				longOperation('loading', function (done) {
					jBinary.loadData(event.target.href, function (err, data) {
						handleData.apply(this, arguments);
						done();
					});
				});
				event.preventDefault();
			});

			if ('File' in this) {
				document.getElementById('fileApi').style.display = 'block';

				document.getElementById('file').addEventListener('change', function () {
					jBinary.loadData(this.files[0], handleData);
				});
			}
		});
	</script>
	<style type="text/css">
		#fileApi {
			display: none;
		}

		table {
			border-collapse: collapse;
			margin: 6pt;
		}

		th, td {
			border: 1px solid #777;
			padding: 3pt;
		}
	</style>
</head>
<body>
	Load GZIP sample: <a id="url" href="sample.tar.gz">Load</a><br />
	<div id="fileApi">
		<small>or</small><br />
		<label for="file">Choose GZIP file:</label><input type="file" id="file" />
	</div>
	<hr />
	<table>
		<tbody id="info"></tbody>
	</table>
	<!--[if lt IE 10]>
	<hr />
	<small>Please note IE&lt;10 doesn't allow to save files from Data-URIs so you won't be able to extract particular files in those browsers from demo. If you want to use their contents in own solution, consider reading it as string or similar ways.</small>
	<![endif]-->
</body>
</html>