<!DOCTYPE html>
<html>
<head>
	<script src="https://rawgithub.com/jDataView/jDataView/master/src/jDataView.js"></script>
	<script src="https://rawgithub.com/jDataView/jBinary/master/src/jBinary.js"></script>
	<script src="bmp.js"></script>
	<script src="https://rawgithub.com/jonathantneal/2869388/raw/989d46f574934be64348b7caf4cc149b007bf76f/eventListener.js"></script>
	<script>
		addEventListener('load', function () {
			var info = document.getElementById('info');
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');

			function longOperation(name, async) {
				var oldTitle = document.title;
				document.title = 'Please wait, ' + name + '...';
				async(function () {
					document.title = oldTitle;
				});
			}

			function drawToCanvas(bmp, image) {
				if (!image.pixelData) {
					throw new TypeError('Sorry, but RLE compressed images are not supported.');
				}

				var imgData = context.createImageData(image.size.horz, image.size.vert);

				if ('set' in imgData.data) {
					imgData.data.set(image.pixelData);
				} else {
					for (var i = 0, length = image.pixelData.length; i < length; i++) {
						imgData.data[i] = image.pixelData[i];
					}
				}

				canvas.width = imgData.width;
				canvas.height = imgData.height;

				// putting image data to given canvas context
				context.putImageData(imgData, 0, 0);
			}

			function handleData(err, data) {
				if (err) {
					return alert(err);
				}

				var bmp = new jBinary(data, jBinary.Repo.BMP), image;

				longOperation('parsing', function (done) {
					image = bmp.read('Image');
					done();
				});

				canvas.width = canvas.height = 0;

				while (info.firstChild) {
					info.removeChild(info.firstChild);
				}

				function iterate(obj, prefix) {
					for (var key in obj) {
						if (key.charAt(0) === '_') {
							continue;
						}

						var value = obj[key];

						// only simple objects; show array as string to reduce size on screen
						if (value.constructor === Object) {
							iterate(value, prefix + key + '.');
						} else {
							if (value.constructor === Array) {
								value = '[...]';
							}

							var row = info.insertRow(-1);

							var head = document.createElement('th');
							head.innerHTML = prefix + key;
							row.appendChild(head);

							var cell = document.createElement('td');
							cell.innerHTML = value;
							row.appendChild(cell);
						}
					}
				}

				iterate(image, '');

				var renderLink = document.createElement('a');
				renderLink.href = '#';
				renderLink.innerHTML = 'Render';
				renderLink.addEventListener('click', function (event) {
					longOperation('rendering', function (done) {
						drawToCanvas(bmp, image);
						done();
					});
					event.preventDefault();
				});

				var row = info.insertRow(-1);

				var head = document.createElement('th');
				head.innerHTML = 'Actions';
				row.appendChild(head);

				var cell = document.createElement('td');
				cell.appendChild(renderLink);
				row.appendChild(cell);
			}

			document.getElementById('url').addEventListener('click', function (event) {
				longOperation('loading', function (done) {
					jBinary.loadData(event.target.href, function (err, data) {
						handleData.apply(this, arguments);
						done();
					});
				});
				event.preventDefault();
			});

			if ('File' in this) {
				document.getElementById('fileApi').style.display = 'block';

				document.getElementById('file').addEventListener('change', function () {
					jBinary.loadData(this.files[0], handleData);
				});
			}
		});
	</script>
	<style type="text/css">
		#fileApi {
			display: none;
		}

		table {
			float: left;
			border-collapse: collapse;
		}

		canvas {
			float: left;
			margin-left: 1em;
		}

		th, td {
			border: 1px solid #777;
			padding: 3pt;
		}
	</style>
</head>
<body>
	Load BMP sample: <span id="url"><a href="1bpp.bmp">1 BPP</a>, <a href="16bpp.bmp">16 BPP</a>, <a href="24bpp.bmp">24 BPP</a></span><br />
	<div id="fileApi">
		<small>or</small><br />
		<label for="file">Choose BMP file:</label><input type="file" id="file" />
	</div>
	<hr />
	<table>
		<tbody id="info"></tbody>
	</table>
	<canvas id="canvas"></canvas>
</body>
</html>